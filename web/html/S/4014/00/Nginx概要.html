<h2>Nginx</h2>
軽量で高い拡張性を持つオープンソースのHTTPサーバです。<br />「エンジンエックス」と読みます。<br />ApacheやIISなどの従来のWEBサーバに比べてかなり新しいアプリケーションであり、ApacheやIISなどの古いWEBサーバの問題を克服した構成となっています。<br /><br />また、使い方もシンプルで分かりやすいことも特徴のひとつです。
<a href="https://www.nginx.co.jp/" class="link nginxLogo">Nginx</a>
近年シェアを急激に伸ばし、現在ではApacheよりもシェアが高くなっているという調査結果もあります。
<img src="/?S00/4014/webserver-share-rate.webp" alt="WEBサーバ シェア" />
<p><a href="https://manuon.com/webserver-share-ranking/">manuon</a>より引用。</p>
僕的にはApacheからNginxへの移行が進んでいるというよりかは、Apache、ないしは自作WEBサーバのロードバランサとしてNginxを採用しているケースが増えてきているように感じています。
<h2>Nginxの特徴</h2>
ApacheやIISと比較した際のNginxの特徴として以下の点が挙げられます。
<ul>
	<li>イベント駆動</li>
	<li>ノンブロッキングI/O</li>
	<li>非同期I/O</li>
</ul>
<h3>イベント駆動</h3>
なんらかのイベントが発生したらある処理を行うという形で処理を実行します。<br />イベントとは具体的には以下のものが該当します。
<ul>
	<li>accept(クライアントからの接続要求)</li>
	<li>read(通信用のディスクリプタが読み込み可能に)</li>
	<li>write(通信用のディスクリプタが書き込み可能に)</li>
</ul>
<h3>ノンブロッキングI/O</h3>
対象のファイルディスクリプタが準備完了になっていない場合に、プロセスの返答待ち状態になることなく、複数の処理を並行します。<br />これをノンブロッキングと呼びます。
<h3>非同期I/O</h3>
入出力処理の最中に、プログラムをブロックすることなく、入出力処理とそれ以外の処理を並行して実行するための仕組みを言います。
<h2>C10K問題</h2>
かつての絶対的なWEBサーバの王者であるApacheが抱えている最大の問題です。<br /><br />「C」はクライアントを意味し、「10K」は「10,000」を意味します。<br />これはクライアントの同時接続数が「10,000」を超えるとハードウェア上の問題はないのにもかかわらず、システムのパフォーマンスが急速に低下することを言います。<br /><br />簡単な説明をすると、Apacheは各リクエストにプロセスを割り当てて処理を行うため、大量のリクエストを受けるとその分だけプロセスを使用することになります。<br /><br />大量のプロセスが走っている状態だと、OSが実行するプロセスを切り替えることにかかるコスト(コンテキストスイッチ)によってパフォーマンスが急激に低下します。<br />これはApacheがマルチスレッドで処理を行うことに起因します。<br /><br />これに対して、Nginxはシングルスレッドで動作し、キューに保存されたデータをイベント駆動方式で実行していくため、C10問題は発生しません。
<h2>長所と短所</h2>
よく、「Apache VS Nginx」という記事を見かけますが、両者に完全上位・下位互換性はありません。<br />それぞれに得意な点、不得意な点があります。
<h3>Nginxの長所</h3>
Nginxはシンプルな処理が得意です。<br />具体的には静的なファイルを対象としたサーバの役割です。<br /><br />これは、Nginxがシングルスレッドで動作することが理由です。
<h3>Nginxの短所</h3>
NginxはApacheに比べて動的ファイルの生成を苦手とします。<br />したがって、動的なレスポンスを行う必要がある場合にはAPサーバを別に用意して、そのサーバに処理を移譲するリバースプロキシとして使用することが多いです。
<h2>使用方法</h2>
上で挙げたNginxの長所と短所から、Nginxは一般的には以下の使われ方をされることが多いです。
<ul>
	<li>静的ファイル専用のWEBサーバ</li>
	<li>リバースプロキシ</li>
	<li>ロードバランサ</li>
</ul>
<h3>静的ファイル専用のWEBサーバ</h3>
Nginxはその性質上、静的ファイルの送信することは得意ですが、動的ファイルの生成は不得意であるため、静的ファイル専用のWEBサーバとして使用されるケースが多いです。
<img src="/?S00/4014/webServer-for-staticFiles.png" alt="静的ファイル用サーバ" />
<h4>リバースプロキシ</h4>
動的にレスポンスを生成する必要がある場合には、別のAPサーバに処理を投げることが多く、この場合にはリバースプロキシとして使用されることとなります。
<img src="/?S00/4014/webServer-as-reverseProxy.png" alt="リバースプロキシ" />
<h4>ロードバランサ</h4>
また、自身が受け取ったリクエストを複数のAPサーバに分散して処理を移譲することでロードバランサとして活用することもできます。
<img src="/?S00/4014/webServer-as-LB.png" alt="ロードバランサ" />
<h2>環境構築</h2>
ここでは、Linux/Ubuntuを想定した環境構築手順を説明します。<br /><br />以下のコマンドでインストール可能です。
<code class="shell">
	sudo apt install nginx
</code>
インストールが完了したら、デーモンとしてこれを実行します。
<code class="shell">
	sudo systemctl start nginx
</code>
終了する場合には以下のコマンドを実行します。
<code class="shell">
	sudo systemctl stop nginx
</code>
自動起動を有効にする場合には以下のコマンドを実行します。
<code class="shell">
	sudo systemctl enable nginx
</code>
Nginxが正常に動作しているかは以下のコマンドで確認できます。
<code class="shell">
	systemctl list-units --type=service
</code>
上のコマンドは現在実行中のデーモン(サービス)一覧を表示します。<br />この中にnginxコマンドが含まれていればok!です。
